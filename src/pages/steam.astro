---
import {i18n} from "@i18n/translation";
import I18nKey from "../i18n/i18nKey";
import MainGridLayout from "../layouts/MainGridLayout.astro";
---

<MainGridLayout title={i18n(I18nKey.steam)} description={i18n(I18nKey.steam)}>
  <!-- 玩家信息卡片 -->
  <div class="w-full rounded-[var(--radius-large)] overflow-hidden relative mb-6">
    <div class="card-base z-10 px-9 py-6 relative w-full">
      <h2 class="font-bold text-3xl mb-6 text-[var(--title-text)]">Steam 玩家信息</h2>
      <div id="player-status" class="text-center py-12">正在加载玩家信息...</div>
      <div id="player-info" class="hidden">
        <div class="flex flex-col md:flex-row items-center gap-6">
          <img id="player-avatar" src="" alt="Steam 头像" class="w-24 h-24 rounded-full object-cover">
          <div class="flex-1">
            <h3 id="player-name" class="text-2xl font-bold mb-2 text-[var(--title-text)]"></h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2 text-sm text-[var(--secondary-text)]">
              <div class="flex items-center gap-2">
                <span class="font-semibold">等级:</span>
                <span id="player-level"></span>
              </div>
              <div class="flex items-center gap-2">
                <span class="font-semibold">游戏数量:</span>
                <span id="total-games"></span>
              </div>
              <div class="flex items-center gap-2">
                <span class="font-semibold">上次登录:</span>
                <span id="player-last-logoff"></span>
              </div>
              <div class="flex items-center gap-2">
                <span class="font-semibold">注册时间:</span>
                <span id="player-created"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 游戏列表卡片 -->
  <div class="w-full rounded-[var(--radius-large)] overflow-hidden relative">
    <div class="card-base z-10 px-9 py-6 relative w-full">
      <div class="flex justify-between items-center mb-6">
        <h2 class="font-bold text-3xl text-[var(--title-text)]">最近游戏</h2>
        <div id="games-status" class="text-sm text-[var(--secondary-text)]">正在加载游戏列表...</div>
      </div>
      <div id="games-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden"></div>
      
    </div>
  </div>

  <!-- 纯 JS 脚本：客户端执行 -->
	<script>
		// API 基础 URL
		const API_BASE = import.meta.env.VITE_API_URL;
		
		// 标记是否正在加载，避免重复请求
		let isLoading = false;
		
		// 格式化时间戳为日期
		const formatDate = (timestamp) => {
			const date = new Date(timestamp * 1000);
			return date.toLocaleDateString('zh-CN', {
				year: 'numeric',
				month: '2-digit',
				day: '2-digit'
			});
		};
		
		// 格式化游玩时间（小时）
		const formatPlaytime = (minutes) => {
			const hours = Math.floor(minutes / 60);
			return `${hours} 小时`;
		};
		
		// 格式化成就完成率
		const formatAchievementRate = (unlock, total) => {
			if (!total || total === 0) return '0%';
			const rate = Math.round((unlock / total) * 100);
			return `${rate}%`;
		};
		
		// 获取数值格式的成就完成率
		const getAchievementRateValue = (unlock, total) => {
			if (!total || total === 0) return 0;
			return Math.round((unlock / total) * 100);
		};
		
		// 获取玩家信息
		const fetchPlayerInfo = async () => {
			const statusEl = document.getElementById('player-status');
			const infoEl = document.getElementById('player-info');
			
			// 如果元素不存在，说明不在当前页面
			if (!statusEl || !infoEl) return;
			
			try {
				const response = await fetch(`${API_BASE}steam-api/player`);
				if (!response.ok) throw new Error('网络响应失败');
				const data = await response.json();
				
				// 再次检查元素是否存在（防止页面切换后更新错误的 DOM）
				if (!document.getElementById('player-status')) return;
				
				if (data.code === 1000 && data.data) {
					const player = data.data;
					
					// 更新玩家信息
					const avatarEl = document.getElementById('player-avatar');
					const nameEl = document.getElementById('player-name');
					const levelEl = document.getElementById('player-level');
					const lastLogoffEl = document.getElementById('player-last-logoff');
					const createdEl = document.getElementById('player-created');
					
					if (avatarEl) avatarEl.src = player.avatarfull;
					if (nameEl) nameEl.textContent = player.personaname;
					if (levelEl) levelEl.textContent = player.level;
					if (lastLogoffEl) lastLogoffEl.textContent = formatDate(player.lastlogoff);
					if (createdEl) createdEl.textContent = formatDate(player.timecreated);
					
					// 显示玩家信息
					infoEl.classList.remove('hidden');
					statusEl.classList.add('hidden');
				} else {
					throw new Error('获取玩家数据失败');
				}
			} catch (err) {
				console.error('获取玩家信息失败:', err);
				if (statusEl) {
					statusEl.innerHTML = '❌ 无法加载玩家信息，请稍后再试。';
				}
			}
		};
		
		// 获取游戏列表
		const fetchGamesList = async () => {
			const statusEl = document.getElementById('games-status');
			const gamesListEl = document.getElementById('games-list');
			const totalGamesEl = document.getElementById('total-games');
			
			if (!statusEl || !gamesListEl || !totalGamesEl) return;
			
			try {
				const response = await fetch(`${API_BASE}steam-api/games`);
				if (!response.ok) throw new Error('网络响应失败');
				const data = await response.json();
				
				if (!document.getElementById('games-status')) return;
				
				if (data.code === 1000 && data.data) {
					const gamesData = data.data;
					const games = gamesData.games;
					
					// 更新状态
					statusEl.textContent = `共 ${games.length} 款游戏`;
					
					// 更新总游戏数
					totalGamesEl.textContent = gamesData.gameCount;
					
					if (games.length > 0) {
						// 渲染游戏列表
						gamesListEl.innerHTML = games.map(game => `
            <div class="bg-[var(--bg-secondary)] rounded-[var(--radius-medium)] overflow-hidden transition-all hover:shadow-md">
              <!-- 游戏封面图 -->
              <div class="relative h-32 overflow-hidden bg-[var(--bg-tertiary)]">
                <img 
                  src="http://shared.fastly.steamstatic.com/store_item_assets/steam/apps/${game.appid}/header.jpg" 
                  alt="${game.name}" 
                  class="w-full h-full object-cover transition-transform duration-300 hover:scale-105"
                  onError="this.onerror=null;this.src='https://via.placeholder.com/460x215?text=No+Cover';"
                >
              </div>
              <!-- 游戏信息 -->
              <div class="p-4">
                <h3 class="font-bold text-lg mb-2 text-[var(--title-text)]">${game.name}</h3>
                <div class="grid grid-cols-2 gap-2 text-sm text-[var(--secondary-text)]">
                  <div class="flex items-center gap-2">
                    <span class="font-semibold">游玩时间:</span>
                    <span>${formatPlaytime(game.playtime_forever)}</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="font-semibold">成就:</span>
                    <span>${game.unLock}/${game.achievementCount} (${formatAchievementRate(game.unLock, game.achievementCount)})</span>
                  </div>
                </div>
                <!-- 成就进度条 -->
                <div class="mt-3">
                  <div class="w-full bg-[var(--bg-tertiary)] rounded-full h-2">
                    <div
                      class="bg-[var(--primary)] h-2 rounded-full transition-all duration-500"
                      style="width: ${getAchievementRateValue(game.unLock, game.achievementCount)}%"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
          `).join('');
						
						gamesListEl.classList.remove('hidden');
					} else {
						gamesListEl.innerHTML = '<div class="col-span-2 text-center py-8 text-[var(--secondary-text)]">暂无游戏数据</div>';
						gamesListEl.classList.remove('hidden');
					}
				} else {
					throw new Error('获取游戏数据失败');
				}
			} catch (err) {
				console.error('获取游戏列表失败:', err);
				if (statusEl) {
					statusEl.innerHTML = '❌ 无法加载游戏列表，请稍后再试。';
				}
			}
		};
		
		// 加载数据的函数
		const loadSteamData = () => {
			// console.log("执行数据加载");
			
			// 避免重复加载
			if (isLoading) {
				// console.log("正在加载中，跳过");
				return;
			}
			
			isLoading = true;
			
			// 重置UI状态
			const playerStatusEl = document.getElementById('player-status');
			const playerInfoEl = document.getElementById('player-info');
			const gamesStatusEl = document.getElementById('games-status');
			const gamesListEl = document.getElementById('games-list');
			
			if (playerStatusEl) playerStatusEl.classList.remove('hidden');
			if (playerInfoEl) playerInfoEl.classList.add('hidden');
			if (gamesStatusEl) gamesStatusEl.textContent = '正在加载游戏列表...';
			if (gamesListEl) gamesListEl.classList.add('hidden');
			
			// 执行请求
			Promise.all([
				fetchPlayerInfo(),
				fetchGamesList()
			]).finally(() => {
				isLoading = false;
				// console.log("数据加载完成");
			});
		};
		
		// 使用 MutationObserver 监听 DOM 变化
		const observeDOM = () => {
			const targetNode = document.body;
			const config = { childList: true, subtree: true };
			
			const callback = (mutationsList, observer) => {
				// 检查我们的元素是否已经添加到 DOM 中
				if (document.getElementById('player-status')) {
					// console.log("目标元素已找到，执行加载");
					loadSteamData();
					observer.disconnect(); // 找到后停止观察
				}
			};
			
			const observer = new MutationObserver(callback);
			observer.observe(targetNode, config);
			
			// 10秒后超时停止观察
			setTimeout(() => observer.disconnect(), 10000);
		};
		
		// 初始化函数
		const init = () => {
			// console.log("初始化 Steam 页面脚本");
			
			// 检查是否在当前页面
			if (document.getElementById('player-status')) {
				// 元素已存在，直接加载
				loadSteamData();
			} else {
				// 元素不存在，监听 DOM 变化
				observeDOM();
			}
		};
		
		// 初始加载
		init();
		
		// 处理页面切换事件
		if (typeof window !== 'undefined') {
			// 直接添加事件监听器到 document，使用事件委托
			document.addEventListener('swup:page:view', () => {
				// console.log("Swup page:view 事件触发");
				setTimeout(init, 50); // 稍微延迟确保 DOM 已更新
			});
			
			document.addEventListener('swup:content:replace', () => {
				// console.log("Swup content:replace 事件触发");
				setTimeout(init, 50);
			});
			
			// 处理浏览器的前进/后退
			window.addEventListener('popstate', () => {
				// console.log("popstate 事件触发");
				setTimeout(init, 100);
			});
		}
	</script>
</MainGridLayout>
