---
import { Icon } from "astro-icon/components";
import { i18n } from "@i18n/translation";
import I18nKey from "@i18n/i18nKey";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { siteConfig } from "../config";
import {
  getCategoryList,
  getSortedPosts,
  getTagList,
} from "../utils/content-utils";

// 从配置中获取站点开始日期
const siteStartDate = siteConfig.siteStartDate || "2025-01-01";

// 获取所有文章
const posts = await getSortedPosts();
const categories = await getCategoryList();
const tags = await getTagList();

// 计算总字数
let totalWords = 0;
for (const post of posts) {
  if (post.body) {
    let text = post.body;

    // 移除代码块
    text = text.replace(/```[\s\S]*?```/g, "");
    // 移除 ` 包裹的行内代码
    text = text.replace(/`[^`]+`/g, "");

    // 使用与 remark-content.mjs 完全一致的 CJK 正则
    const cjkPattern =
      /[\u4e00-\u9fa5\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af\u3000-\u303f\uff00-\uffef]/g;

    const cjkMatches = text.match(cjkPattern);
    const cjkCount = cjkMatches ? cjkMatches.length : 0;

    // 计算非 CJK 单词数
    const nonCjkText = text.replace(cjkPattern, " ");

    // 按空白字符分割，计算单词数量
    const nonCjkWords = nonCjkText
      .split(/\s+/)
      .filter((word) => word.trim().length > 0);

    totalWords += cjkCount + nonCjkWords.length;
  }
}

// 格式化数字（添加千位分隔符）
function formatNumber(num: number): string {
  return num.toLocaleString();
}

// 获取最新文章日期（忽略置顶状态，只按发布日期排序）
const latestPost = posts.reduce((latest, post) => {
  if (!latest) return post;
  return post.data.published > latest.data.published ? post : latest;
}, posts[0]);

const lastPostDate = latestPost
  ? latestPost.data.published.toISOString()
  : null;

const stats = [
  {
    icon: "material-symbols:article-outline",
    label: i18n(I18nKey.siteStatsPostCount),
    value: posts.length,
  },
  {
    icon: "material-symbols:folder-outline",
    label: i18n(I18nKey.siteStatsCategoryCount),
    value: categories.length,
  },
  {
    icon: "material-symbols:label-outline",
    label: i18n(I18nKey.siteStatsTagCount),
    value: tags.length,
  },
  {
    icon: "material-symbols:text-ad-outline-rounded",
    label: i18n(I18nKey.siteStatsTotalWords),
    value: totalWords,
    formatted: true,
  },
  {
    icon: "material-symbols:calendar-clock-outline",
    label: i18n(I18nKey.siteStatsRunningDays),
    value: 0, // 将由客户端更新
    suffix: i18n(I18nKey.siteStatsDays).replace("{days}", ""),
    dynamic: true,
    id: "running-days",
  },
  {
    icon: "material-symbols:ecg-heart-outline",
    label: i18n(I18nKey.siteStatsLastUpdate),
    value: 0, // 将由客户端更新
    suffix: i18n(I18nKey.siteStatsDaysAgo).replace("{days}", ""),
    dynamic: true,
    id: "last-update",
  },
];
---
<MainGridLayout title={i18n(I18nKey.statistics)} description={i18n(I18nKey.statistics)}>
  <!-- 玩家信息卡片 -->
  <div class="w-full rounded-[var(--radius-large)] overflow-hidden relative mb-6">
    <div class="card-base z-10 px-9 py-6 relative w-full">
      <h2 class="font-bold text-3xl mb-6 text-[var(--title-text)]">{i18n(I18nKey.siteStats)}</h2>
      
      <!-- 统计数据网格 -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {stats.map((stat) => (
          <div class="bg-[var(--bg-secondary)] rounded-[var(--radius-medium)] p-6 transition-all hover:shadow-md">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="text-[var(--primary)] text-2xl p-3 bg-[var(--bg-tertiary)] rounded-full">
                  <Icon name={stat.icon} />
                </div>
                <div>
                  <h3 class="text-sm font-medium text-[var(--secondary-text)]">{stat.label}</h3>
                  <p 
                    class="text-3xl font-bold text-[var(--title-text)] mt-1"
                    data-stat-id={stat.id}
                  >
                    {stat.formatted ? formatNumber(stat.value) : stat.value}
                    {stat.suffix && (
                      <span class="text-base font-normal text-[var(--secondary-text)] ml-2">
                        {stat.suffix}
                      </span>
                    )}
                  </p>
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </div>

  <script is:inline define:vars={{ siteStartDate, lastPostDate }}>
    function updateDynamicStats() {
      const today = new Date();

      // 更新运行天数
      const startDate = new Date(siteStartDate);
      const diffTime = Math.abs(today.getTime() - startDate.getTime());
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      const runningDaysElements = document.querySelectorAll(
        '[data-stat-id="running-days"]',
      );
      if (runningDaysElements.length > 0) {
        runningDaysElements.forEach(element => {
          element.textContent = diffDays.toString();
        });
      }

      // 更新最后活动时间
      if (lastPostDate) {
        const lastPost = new Date(lastPostDate);
        const timeSinceLastPost = Math.abs(
          today.getTime() - lastPost.getTime(),
        );
        const daysSinceLastUpdate = Math.floor(
          timeSinceLastPost / (1000 * 60 * 60 * 24),
        );

        const lastUpdateElements = document.querySelectorAll(
          '[data-stat-id="last-update"]',
        );
        if (lastUpdateElements.length > 0) {
          lastUpdateElements.forEach(element => {
            element.textContent = daysSinceLastUpdate.toString();
          })
        }
      }
    }

    // 页面加载时更新
    updateDynamicStats();

    // 每小时更新一次（可选，因为天数变化较慢）
    setInterval(updateDynamicStats, 60 * 60 * 1000);
  </script>
</MainGridLayout>
